<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Newsfeed</title>
<style type="text/css">
#main {
	height: 600px;
	width: 450px;
	position: fixed;
	top: 20%;
	left: 45%;
	margin-top: -100px;
	margin-left: -125px;
}

#feed {
	width: 100%;
}
</style>
</head>
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.0.min.js"></script>
<script src="/common.js"></script>
<script type="text/javascript">
	var currentPage = 0;
	function reloadFeed() {
		$.ajax({
			url : "/feed/" + currentPage,
			dataType : "json",
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : function(data) {
				displayMessages(data);
			},
			error : function() {
				window.location = "/login.html";
			}
		});
	}

	function getAuthorMessageCell(author, authorId){
		return "<td class='authorRow'><div class='" + authorId + "'>" + author + "</div></td>"
	}
	
	function displayMessages(messages) {
		var body = $('#feed > tbody');
		body.children().remove();

		for (mess in messages) {
			var messHtml = "<tr style='colspan: 3;' class='messageRow' id='" + messages[mess]["_id"] + "'>";
			messHtml += getAuthorMessageCell(messages[mess].author, messages[mess].authorId);
			messHtml += "<td>" + messages[mess].text + "</td>";
			if(messages[mess]["liked"]){
				messHtml += "<td><a class='unlike' href='#'>D<a/></td>";
			}else{
				messHtml += "<td><a class='like' href='#'>L<a/></td>";
			} 
			messHtml += "<td><a class='silence' href='#'>silence<a/></td>";
			
			messHtml += "</tr>";
			
			body.append(messHtml);
		}
		
		$(".like").click(function(){
			var messageId = $(this).parents(".messageRow").attr('id');
			vote(messageId, 'like');
		});
		$(".unlike").click(function(){
			var messageId = $(this).parents(".messageRow").attr('id');
			vote(messageId, 'unlike');
		});
		$(".silence").click(function(){
			var authorUsername = $(this).parents(".messageRow").children(".authorRow").children("div").attr('class');
			silence(authorUsername);
		});
	}

	function vote(messageId, vote){
		$.ajax({
			url : "/message/" + messageId + "/" + vote,
			method : "POST",
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : reloadFeed,
			error : function(data) {
				alert(JSON.parse(data.responseText)["message"]);
			}
		});
	}
	
	function silence(userId){
		$.ajax({
			url : "/user/" + userId + "/silence",
			method : "POST",
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : reloadFeed,
			error : function(data) {
				alert(JSON.parse(data.responseText)["message"]);
			}
		});
	}

	function postMessage(messageText) {
		$.ajax({
			url : "/feed",
			method : "POST",
			contentType: "application/json",
			data : JSON.stringify({
				text : messageText
			}),
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : reloadFeed,
			error : function(data) {
				alert(JSON.parse(data.responseText)["message"]);
			}
		});
	}
	
	$(document).ready(function(){
		$("#message").keypress(function (e) {
			  if (e.which == 13) {
				  postMessage(this.value);
				  this.value = "";
				  return false;
			  }
		});
		$("#prev").click(function(){
			if(currentPage > 0){
				currentPage--;
				reloadFeed();
			}
		});
		$("#next").click(function(){
			//if(currentPage > 0){
				currentPage++;
				reloadFeed();
			//}
		});
		
		reloadFeed();
		setInterval(reloadFeed, 5000);
	})
</script>
<body>
	<table id="main" style="border: 1px solid black;">
		<tbody>
			<tr>
				<td style="colspan: 3">
					<table id="feed">
						<tbody>
							<tr>
								<td>NO CONNECTION TO SERVER</td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
			<tr>
				<td style="position: relative; left: 40%;">
					<a href="#" id="prev">&lt;&lt;</a>&nbsp;&nbsp;&nbsp;<a id="next" href="#">&gt;&gt;</a>
				</td>
			</tr>
			<tr>
				<td style="colspan: 3;"><input type="text" id="message"
					style="width: 100%; height: 20px;"
					placeholder="Type here..." /></td>
			</tr>
		</tbody>
	</table>
</body>
</html>