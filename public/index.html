<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Newsfeed</title>
<style type="text/css">
#main {
	height: 600px;
	width: 800px;
	position: fixed;
	top: 20%;
	left: 35%;
	margin-top: -100px;
	margin-left: -125px;
}

#feed {
	width: 100%;
}
.date {
	font-size: 10px;
}
.authorCell {
	font-size: 14px;
}
.silence {
	margin: 5px;
}
</style>
</head>
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.0.min.js"></script>
<script src="http://ejohn.org/files/pretty.js"></script>
<script src="/common.js"></script>
<script type="text/javascript">
	var currentPage = 0;
	var authorsCache = {};
	
	function reloadFeed() {
		$.ajax({
			url : "/feed/" + currentPage,
			dataType : "json",
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : function(data) {
				displayMessages(data);
			},
			error : function() {
				window.location = "/login.html";
			}
		});
	}

	function updateAuthorsData(messages){
		var authorsIds = [];
		for(eachMessage in messages){
			authorsIds.push(messages[eachMessage].authorId);
		}
		
		$.ajax({
			url : "/user/data/batch",
			method : "GET",
			data: {ids:authorsIds},
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : function(data){
				authorsCache = data;
				
				for(eachMessage in messages){
					$('#' + messages[eachMessage]._id + ' td:first-child').html(getAuthorCell(messages[eachMessage].authorId));
				}
			},
			error : function(data) {
				alert(JSON.parse(data.responseText)["message"]);
			}
		});
	}	
	
	function getAuthorCell(authorId){
		var avatar = "";
		if(authorsCache[authorId] && authorsCache[authorId].avatar/*  && authorsCache[authorId].avatar.length > 30 */){
			avatar = "<img style='height: 30px; width: 30px;' src='data:image/jpeg;base64," + authorsCache[authorId].avatar + "'/>";
		}

		return "<div class='" + authorId + "'>" +  avatar + "<span style='margin-left: 8px;'>" + authorsCache[authorId].username + "</span>"
		+ "<a class='silence' href='#'>silence</a></div>";
	}
	
	function displayMessages(messages) {
		var body = $('#feed > tbody');
		body.children().remove();

		for (mess in messages) {
			if(!authorsCache[messages[mess].authorId]){
				authorsCache[messages[mess].authorId] = {username: messages[mess].author, authorId: messages[mess].authorId};
			}
			
			var messHtml = "<tr style='colspan: 3;' class='messageRow' id='" + messages[mess]["_id"] + "'>";
			messHtml += "<td class='authorCell' style='vertical-align: middle;'>" + getAuthorCell(messages[mess].authorId) + "</td>";
			messHtml += "<td>" + messages[mess].text + "</td>";
			if(messages[mess]["liked"]){
				messHtml += "<td><a class='unlike' href='#'>D</a></td>";
			}else{
				messHtml += "<td><a class='like' href='#'>L</a></td>";
			} 
			
			var dateInUTC = new Date(messages[mess].date + 2 * 3600 * 1000).toISOString();
			messHtml += "<td><div class='date'>" + prettyDate(dateInUTC) + "</div></td>";
			
			messHtml += "</tr>";
			
			body.append(messHtml);
		}
		
		$(".like").click(function(){
			var messageId = $(this).parents(".messageRow").attr('id');
			vote(messageId, 'like');
		});
		$(".unlike").click(function(){
			var messageId = $(this).parents(".messageRow").attr('id');
			vote(messageId, 'unlike');
		});
		$(".silence").click(function(){
			var authorId = $(this).parents(".messageRow").children("td.authorCell").children("div").attr('class');
			silence(authorId);
		});
		
		updateAuthorsData(messages);
	}

	function vote(messageId, vote){
		$.ajax({
			url : "/message/" + messageId + "/" + vote,
			method : "POST",
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : reloadFeed,
			error : function(data) {
				alert(JSON.parse(data.responseText)["message"]);
			}
		});
	}
	
	function silence(userId){
		$.ajax({
			url : "/user/" + userId + "/silence",
			method : "POST",
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : reloadFeed,
			error : function(data) {
				alert(JSON.parse(data.responseText)["message"]);
			}
		});
	}

	function postMessage(messageText) {
		$.ajax({
			url : "/feed",
			method : "POST",
			contentType: "application/json",
			data : JSON.stringify({
				text : messageText
			}),
			headers : {
				"Authorization" : readCookie("sessionId")
			},
			success : reloadFeed,
			error : function(data) {
				alert(JSON.parse(data.responseText)["message"]);
			}
		});
	}
	
	$(document).ready(function(){
		$("#message").keypress(function (e) {
			  if (e.which == 13) {
				  postMessage(this.value);
				  this.value = "";
				  return false;
			  }
		});
		$("#prev").click(function(){
			if(currentPage > 0){
				currentPage--;
				reloadFeed();
			}
		});
		$("#next").click(function(){
			//if(currentPage > 0){
				currentPage++;
				reloadFeed();
			//}
		});
		
		reloadFeed();
		setInterval(reloadFeed, 5000);
	})
</script>
<body>
	<table id="main" style="border: 1px solid black;">
		<tbody>
			<tr>
				<td style="colspan: 3">
					<table id="feed">
						<tbody>
							<tr>
								<td>NO CONNECTION TO SERVER</td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
			<tr>
				<td style="position: relative; left: 40%;">
					<a href="#" id="prev">&lt;&lt;</a>&nbsp;&nbsp;&nbsp;<a id="next" href="#">&gt;&gt;</a>
				</td>
			</tr>
			<tr>
				<td style="colspan: 3;"><input type="text" id="message"
					style="width: 100%; height: 20px;"
					placeholder="Type here..." /></td>
			</tr>
		</tbody>
	</table>
</body>
</html>